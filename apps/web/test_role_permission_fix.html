<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²æƒé™è®¾ç½®ä¿®å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .result { background: #f8f9fa; padding: 10px; border-radius: 3px; white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>è§’è‰²æƒé™è®¾ç½®ä¿®å¤æµ‹è¯•</h1>
        
        <div class="section">
            <h2>é—®é¢˜æè¿°</h2>
            <p>ä¹‹å‰å‡ºç°"è¯·æ±‚é”™è¯¯: è®¾ç½®è§’è‰²èœå•æƒé™å¤±è´¥"çš„é”™è¯¯ï¼ŒåŸå› æ˜¯MySQLæ‰¹é‡æ’å…¥è¯­æ³•é”™è¯¯ã€‚</p>
            <p><strong>ä¿®å¤å†…å®¹ï¼š</strong></p>
            <ul>
                <li>ä¿®å¤äº† role.service.ts ä¸­çš„ setRoleMenus å‡½æ•°</li>
                <li>ä¿®å¤äº† menu.service.ts ä¸­çš„ assignRoleMenus å‡½æ•°</li>
                <li>ä¿®å¤äº†ç”¨æˆ·è§’è‰²åˆ†é…ç›¸å…³çš„SQLè¯­å¥</li>
            </ul>
        </div>
        
        <div class="section">
            <h2>æµ‹è¯•æ­¥éª¤</h2>
            <div class="test-item">
                <h3>æ­¥éª¤1: æµ‹è¯•è§’è‰²æƒé™è®¾ç½®API</h3>
                <button class="button" onclick="testRolePermissionAPI()">ğŸ”§ æµ‹è¯•æƒé™è®¾ç½®API</button>
                <div id="apiResult" class="result"></div>
            </div>
            
            <div class="test-item">
                <h3>æ­¥éª¤2: æ‰“å¼€è§’è‰²ç®¡ç†é¡µé¢è¿›è¡Œå®é™…æµ‹è¯•</h3>
                <button class="button" onclick="openRolePage()">ğŸš€ æ‰“å¼€è§’è‰²ç®¡ç†é¡µé¢</button>
                <p style="margin-top: 10px; font-size: 14px; color: #666;">
                    ç‚¹å‡»åè¯·ï¼š<br>
                    1. ç‚¹å‡»ä»»æ„è§’è‰²çš„"æƒé™è®¾ç½®"æŒ‰é’®<br>
                    2. é€‰æ‹©æˆ–å–æ¶ˆé€‰æ‹©ä¸€äº›èœå•æƒé™<br>
                    3. ç‚¹å‡»"ä¿å­˜"æŒ‰é’®<br>
                    4. æŸ¥çœ‹æ˜¯å¦å‡ºç°"æƒé™è®¾ç½®æˆåŠŸ"çš„æç¤º
                </p>
            </div>
            
            <div class="test-item">
                <h3>æ­¥éª¤3: éªŒè¯æƒé™è®¾ç½®ç»“æœ</h3>
                <button class="button" onclick="verifyPermissions()">âœ… éªŒè¯æƒé™è®¾ç½®</button>
                <div id="verifyResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        async function testRolePermissionAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.textContent = 'æ­£åœ¨æµ‹è¯•è§’è‰²æƒé™è®¾ç½®API...';
            
            try {
                // é¦–å…ˆè·å–è§’è‰²åˆ—è¡¨
                const rolesResponse = await fetch('/api/roles');
                const rolesData = await rolesResponse.json();
                
                if (!rolesData.success || !rolesData.data || rolesData.data.length === 0) {
                    throw new Error('æ— æ³•è·å–è§’è‰²åˆ—è¡¨');
                }
                
                const testRole = rolesData.data[0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªè§’è‰²è¿›è¡Œæµ‹è¯•
                
                // è·å–æ‰€æœ‰èœå•
                const menusResponse = await fetch('/api/menu/menus');
                const menusData = await menusResponse.json();
                
                if (!menusData.success || !menusData.data) {
                    throw new Error('æ— æ³•è·å–èœå•åˆ—è¡¨');
                }
                
                // é€‰æ‹©å‰3ä¸ªèœå•è¿›è¡Œæµ‹è¯•
                const testMenuIds = menusData.data.slice(0, 3).map(menu => menu.id);
                
                // æµ‹è¯•è®¾ç½®è§’è‰²æƒé™
                const setPermissionResponse = await fetch(`/api/roles/${testRole.id}/menus`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        menuIds: testMenuIds
                    })
                });
                
                const setPermissionData = await setPermissionResponse.json();
                
                if (setPermissionData.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `âœ… æƒé™è®¾ç½®APIæµ‹è¯•æˆåŠŸï¼\n\næµ‹è¯•è§’è‰²: ${testRole.name}\nè®¾ç½®èœå•æ•°é‡: ${testMenuIds.length}\nå“åº”æ¶ˆæ¯: ${setPermissionData.message}`;
                } else {
                    throw new Error(setPermissionData.message || 'æƒé™è®¾ç½®å¤±è´¥');
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        function openRolePage() {
            window.open('http://localhost:5176/admin/roles', '_blank');
        }
        
        async function verifyPermissions() {
            const resultDiv = document.getElementById('verifyResult');
            resultDiv.textContent = 'æ­£åœ¨éªŒè¯æƒé™è®¾ç½®ç»“æœ...';
            
            try {
                // è·å–è§’è‰²åˆ—è¡¨
                const rolesResponse = await fetch('/api/roles');
                const rolesData = await rolesResponse.json();
                
                if (!rolesData.success || !rolesData.data) {
                    throw new Error('æ— æ³•è·å–è§’è‰²åˆ—è¡¨');
                }
                
                let verificationResults = [];
                
                // éªŒè¯æ¯ä¸ªè§’è‰²çš„æƒé™è®¾ç½®
                for (const role of rolesData.data.slice(0, 3)) { // åªéªŒè¯å‰3ä¸ªè§’è‰²
                    try {
                        const permissionResponse = await fetch(`/api/roles/${role.id}/menus`);
                        const permissionData = await permissionResponse.json();
                        
                        if (permissionData.success) {
                            verificationResults.push(`âœ… è§’è‰² "${role.name}" æƒé™è·å–æˆåŠŸï¼Œæ‹¥æœ‰ ${permissionData.data.length} ä¸ªèœå•æƒé™`);
                        } else {
                            verificationResults.push(`âŒ è§’è‰² "${role.name}" æƒé™è·å–å¤±è´¥: ${permissionData.message}`);
                        }
                    } catch (error) {
                        verificationResults.push(`âŒ è§’è‰² "${role.name}" éªŒè¯å‡ºé”™: ${error.message}`);
                    }
                }
                
                resultDiv.className = 'result success';
                resultDiv.textContent = verificationResults.join('\n');
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `âŒ éªŒè¯å¤±è´¥: ${error.message}`;
            }
        }
    </script>
</body>
</html>