<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色权限最终测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-item { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:hover { background: #0056b3; }
        .result { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 角色权限功能最终测试</h1>
        
        <div class="test-item info">
            <h3>测试说明</h3>
            <p>此页面用于验证角色管理页面的菜单权限设置功能是否正常工作。</p>
            <p>预期结果：菜单数据能够正确加载并在权限设置弹窗中显示为树形结构。</p>
        </div>
        
        <div class="test-item">
            <h3>步骤1: 测试菜单API</h3>
            <button class="button" onclick="testMenuAPI()">🔍 测试菜单API</button>
            <div id="apiResult" class="result"></div>
        </div>
        
        <div class="test-item">
            <h3>步骤2: 模拟前端处理逻辑</h3>
            <button class="button" onclick="simulateProcessing()">⚙️ 模拟数据处理</button>
            <div id="processResult" class="result"></div>
        </div>
        
        <div class="test-item">
            <h3>步骤3: 访问角色管理页面</h3>
            <button class="button" onclick="openRolePage()">🚀 打开角色管理页面</button>
            <p style="margin-top: 10px; font-size: 14px; color: #666;">点击后请：<br>1. 点击任意角色的"权限设置"按钮<br>2. 查看菜单权限部分是否显示菜单树<br>3. 检查浏览器控制台的调试信息</p>
        </div>
        
        <div class="test-item">
            <h3>步骤4: 检查控制台日志</h3>
            <button class="button" onclick="checkConsole()">📋 输出调试信息</button>
            <p style="margin-top: 10px; font-size: 14px; color: #666;">请打开浏览器开发者工具查看详细日志</p>
        </div>
    </div>

    <script>
        let testResults = {
            apiTest: null,
            processTest: null
        };
        
        async function testMenuAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.textContent = '正在测试菜单API...';
            
            try {
                const response = await fetch('/api/menu/menus', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('API测试 - 响应状态:', response.status);
                const data = await response.json();
                console.log('API测试 - 响应数据:', data);
                
                if (response.ok) {
                    testResults.apiTest = { success: true, data };
                    resultDiv.textContent = `✅ API测试成功\n状态码: ${response.status}\n数据类型: ${Array.isArray(data) ? '数组' : '对象'}\n菜单数量: ${Array.isArray(data) ? data.length : (data.data ? data.data.length : '未知')}\n\n响应预览:\n${JSON.stringify(data, null, 2).substring(0, 500)}...`;
                } else {
                    testResults.apiTest = { success: false, error: data };
                    resultDiv.textContent = `❌ API测试失败\n状态码: ${response.status}\n错误信息: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                console.error('API测试错误:', error);
                testResults.apiTest = { success: false, error: error.message };
                resultDiv.textContent = `❌ 网络错误: ${error.message}`;
            }
        }
        
        function simulateProcessing() {
            const resultDiv = document.getElementById('processResult');
            
            if (!testResults.apiTest || !testResults.apiTest.success) {
                resultDiv.textContent = '⚠️ 请先执行步骤1的API测试';
                return;
            }
            
            try {
                const responseData = testResults.apiTest.data;
                let menuData = [];
                
                // 模拟修复后的处理逻辑
                if (responseData) {
                    if (Array.isArray(responseData)) {
                        menuData = responseData;
                        console.log('模拟处理 - 检测到直接数组格式，菜单数量:', menuData.length);
                    } else if (responseData.data && Array.isArray(responseData.data)) {
                        menuData = responseData.data;
                        console.log('模拟处理 - 检测到标准格式，菜单数量:', menuData.length);
                    } else if (responseData.success && responseData.data) {
                        menuData = responseData.data;
                        console.log('模拟处理 - 检测到success格式，菜单数量:', menuData.length);
                    }
                }
                
                if (menuData.length > 0) {
                    testResults.processTest = { success: true, menuData };
                    resultDiv.textContent = `✅ 数据处理成功\n菜单数量: ${menuData.length}\n第一个菜单: ${menuData[0]?.title || '无标题'}\n最后一个菜单: ${menuData[menuData.length-1]?.title || '无标题'}\n\n菜单列表预览:\n${menuData.slice(0, 5).map(m => `- ${m.title} (ID: ${m.id})`).join('\n')}${menuData.length > 5 ? '\n...' : ''}`;
                } else {
                    testResults.processTest = { success: false, error: '没有找到有效菜单数据' };
                    resultDiv.textContent = `❌ 数据处理失败\n原因: 没有找到有效的菜单数据\n响应格式: ${JSON.stringify(responseData, null, 2)}`;
                }
            } catch (error) {
                console.error('数据处理错误:', error);
                testResults.processTest = { success: false, error: error.message };
                resultDiv.textContent = `❌ 处理错误: ${error.message}`;
            }
        }
        
        function openRolePage() {
            window.open('/admin/roles', '_blank');
        }
        
        function checkConsole() {
            console.log('=== 角色权限测试结果汇总 ===');
            console.log('API测试结果:', testResults.apiTest);
            console.log('数据处理测试结果:', testResults.processTest);
            console.log('当前时间:', new Date().toLocaleString());
            console.log('测试页面URL:', window.location.href);
            
            alert('调试信息已输出到控制台，请查看开发者工具的Console标签页');
        }
        
        // 页面加载时自动执行API测试
        window.onload = function() {
            console.log('角色权限测试页面加载完成');
            setTimeout(() => {
                testMenuAPI();
            }, 500);
        };
    </script>
</body>
</html>