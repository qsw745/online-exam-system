<!DOCTYPE html>
<html>
<head>
    <title>菜单树构建测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        .tree-item { margin-left: 20px; }
    </style>
</head>
<body>
    <h1>菜单树构建测试</h1>
    
    <div class="debug-section">
        <h2>1. 获取菜单数据</h2>
        <div id="menu-data"></div>
    </div>
    
    <div class="debug-section">
        <h2>2. 构建菜单树</h2>
        <div id="tree-data"></div>
    </div>
    
    <div class="debug-section">
        <h2>3. 树形结构可视化</h2>
        <div id="tree-visual"></div>
    </div>
    
    <script>
        // 模拟前端的buildMenuTree函数
        function buildMenuTree(menuList) {
            console.log('构建菜单树，输入菜单列表:', menuList);
            const menuMap = new Map();
            const rootMenus = [];

            // 初始化所有菜单项
            menuList.forEach(menu => {
                menuMap.set(menu.id, { ...menu, children: [] });
            });

            // 构建树形结构
            menuList.forEach(menu => {
                const menuItem = menuMap.get(menu.id);
                if (menu.parent_id && menuMap.has(menu.parent_id)) {
                    menuMap.get(menu.parent_id).children.push(menuItem);
                } else {
                    rootMenus.push(menuItem);
                }
            });

            console.log('根菜单项:', rootMenus);

            // 转换为 Tree 组件需要的格式
            const convertToTreeData = (items) => {
                return items.map(item => ({
                    key: item.id,
                    title: item.title,
                    children: item.children.length > 0 ? convertToTreeData(item.children) : undefined
                }));
            };

            const treeData = convertToTreeData(rootMenus);
            console.log('最终树形数据:', treeData);
            return treeData;
        }
        
        // 可视化树形结构
        function visualizeTree(treeData, level = 0) {
            let html = '';
            treeData.forEach(node => {
                const indent = '&nbsp;'.repeat(level * 4);
                html += `<div>${indent}├─ ${node.title} (ID: ${node.key})</div>`;
                if (node.children) {
                    html += visualizeTree(node.children, level + 1);
                }
            });
            return html;
        }
        
        async function testMenuTreeBuild() {
            const menuDataDiv = document.getElementById('menu-data');
            const treeDataDiv = document.getElementById('tree-data');
            const treeVisualDiv = document.getElementById('tree-visual');
            
            try {
                // 1. 获取菜单数据
                const response = await fetch('/api/menu/menus');
                const data = await response.json();
                
                menuDataDiv.innerHTML = `
                    <p><strong>API状态:</strong> ${response.status}</p>
                    <p><strong>菜单数量:</strong> ${data.data ? data.data.length : 0}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                if (data.success && data.data) {
                    // 2. 构建菜单树
                    const treeData = buildMenuTree(data.data);
                    
                    treeDataDiv.innerHTML = `
                        <p><strong>树形数据节点数:</strong> ${treeData.length}</p>
                        <pre>${JSON.stringify(treeData, null, 2)}</pre>
                    `;
                    
                    // 3. 可视化树形结构
                    treeVisualDiv.innerHTML = `
                        <p><strong>树形结构:</strong></p>
                        <div style="font-family: monospace;">${visualizeTree(treeData)}</div>
                    `;
                } else {
                    treeDataDiv.innerHTML = '<p style="color: red;">无法获取菜单数据</p>';
                    treeVisualDiv.innerHTML = '<p style="color: red;">无法构建树形结构</p>';
                }
                
            } catch (error) {
                menuDataDiv.innerHTML = `<p style="color: red;">错误: ${error.message}</p>`;
                console.error('测试失败:', error);
            }
        }
        
        // 页面加载后自动执行测试
        window.onload = testMenuTreeBuild;
    </script>
</body>
</html>